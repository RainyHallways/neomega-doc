import{_ as s,c as n,o as a,Q as l}from"./chunks/framework.c009d427.js";const _=JSON.parse('{"title":"快速入门","description":"快速入门","frontmatter":{"lang":"zh-CN","title":"快速入门","description":"快速入门","sidebar":"auto"},"headers":[],"relativePath":"coromega_examples/tutorial_for_amateur_60_min_blitz/index.md","filePath":"coromega_examples/tutorial_for_amateur_60_min_blitz/index.md","lastUpdated":1724487756000}'),o={name:"coromega_examples/tutorial_for_amateur_60_min_blitz/index.md"},p=l(`<h1 id="猴子也能学会的插件编写-60分钟闪电战" tabindex="-1">猴子也能学会的插件编写/60分钟闪电战 <a class="header-anchor" href="#猴子也能学会的插件编写-60分钟闪电战" aria-label="Permalink to &quot;猴子也能学会的插件编写/60分钟闪电战&quot;">​</a></h1><p>在本教程中, 我们将一同编写一个 &quot;玩家封禁&quot; 插件<br> 这个插件虽然功能比较简单, 但是可以很好的展示一个插件常用 API<br> 好了, 现在试着跟着教程进行吧!</p><h2 id="step-0-做好开发准备" tabindex="-1">Step 0. 做好开发准备 <a class="header-anchor" href="#step-0-做好开发准备" aria-label="Permalink to &quot;Step 0. 做好开发准备&quot;">​</a></h2><ul><li><p>开发 neomega 的 lua 插件不需要任何额外的软件, 但是我们还是推荐您使用一个具备语法高亮的编辑器进行后续的编辑, vscode 是一个不错的选项, 您也可以使用您偏好的软件, 或者, MCSM 自带的编辑器也不是不能用</p></li><li><p>现在, 将您的的 neomega 运行起来, 当它成功运行的时候, 应该会显示 <strong>输入 ? 显示后台菜单</strong> 和 <strong>输入 reload 重启 Omega</strong> 这两条信息, 当您看到这两条信息时, 说明开发准备已经完成了, 我们将显示这两条信息的地方称为 <em><strong>终端</strong></em></p></li><li><p>由于 &quot;玩家封禁&quot; 和 neomega 内置插件重名了, 因此请删除 <strong>neomega_storage/config/玩家封禁[lua]</strong> 和 <strong>neomega_storage/lang/LuaLoader/玩家封禁.lua</strong></p></li></ul><h2 id="step-1-创建插件" tabindex="-1">Step 1. 创建插件 <a class="header-anchor" href="#step-1-创建插件" aria-label="Permalink to &quot;Step 1. 创建插件&quot;">​</a></h2><ul><li>neomega 里自带了插件创建工具, 当您在终端输入 ? 时, 可以看到弹出的菜单中存在选项: <strong>create [plugin_name] [describe]: 创建新插件</strong></li><li>在终端中输入 <strong>create</strong>, 当询问插件名时, 输入 <strong>玩家封禁</strong>, 当询问插件描述的时候, 输入 <strong>从终端、游戏菜单、或透过 QQ 封禁、解封玩家</strong></li><li>此时, 终端的显示应该类似于:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">开始创建插件 玩家封禁: </span></span>
<span class="line"><span style="color:#e1e4e8;">        代码文件位于: &lt;路径&gt;/neomega_storage/lang/LuaLoader/玩家封禁.lua </span></span>
<span class="line"><span style="color:#e1e4e8;">        配置文件夹位于: &lt;路径&gt;/neomega_storage/config/玩家封禁[lua]</span></span>
<span class="line"><span style="color:#e1e4e8;">插件 玩家封禁 创建成功, 输入 reload 使之生效</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">开始创建插件 玩家封禁: </span></span>
<span class="line"><span style="color:#24292e;">        代码文件位于: &lt;路径&gt;/neomega_storage/lang/LuaLoader/玩家封禁.lua </span></span>
<span class="line"><span style="color:#24292e;">        配置文件夹位于: &lt;路径&gt;/neomega_storage/config/玩家封禁[lua]</span></span>
<span class="line"><span style="color:#24292e;">插件 玩家封禁 创建成功, 输入 reload 使之生效</span></span></code></pre></div>如果你的终端报错了, 请按终端提示排除错误</li><li>现在, 输入 reload, 插件将立刻生效</li><li>此时, 输入 ?, 菜单中应该出现 <strong>玩家封禁 [arg1] [arg2] ...: 从终端、游戏菜单、或透过 QQ 封禁、解封玩家</strong>, 如果在终端中输入 <strong>玩家封禁</strong> 可以看到显示 <strong>hello from 玩家封禁!</strong>, 恭喜, 插件已经创建成功了</li><li>现在, 打开 &lt;路径&gt;/neomega_storage/lang/LuaLoader/玩家封禁.lua 您应该能看到自动生成的初始代码, 它看起来应该像这样:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> omega </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;omega&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> json </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;json&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#79B8FF;">package.path</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;%s;%s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">package.path</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    omega.</span><span style="color:#B392F0;">storage_path</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">get_code_path</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;LuaLoader&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;?.lua&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> coromega </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;coromega&quot;</span><span style="color:#E1E4E8;">).</span><span style="color:#79B8FF;">from</span><span style="color:#E1E4E8;">(omega)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;config of 玩家封禁:  &quot;</span><span style="color:#E1E4E8;">,json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;玩家封禁&quot; </span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[arg1] [arg2] ...&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端、游戏菜单、或透过 QQ 封禁、解封玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;hello from 玩家封禁!&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">run</span><span style="color:#E1E4E8;">()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> omega </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;omega&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> json </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;json&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">package.path</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;%s;%s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">package.path</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    omega.</span><span style="color:#6F42C1;">storage_path</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">get_code_path</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;LuaLoader&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;?.lua&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> coromega </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;coromega&quot;</span><span style="color:#24292E;">).</span><span style="color:#005CC5;">from</span><span style="color:#24292E;">(omega)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;config of 玩家封禁:  &quot;</span><span style="color:#24292E;">,json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;玩家封禁&quot; </span><span style="color:#24292E;">},</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[arg1] [arg2] ...&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端、游戏菜单、或透过 QQ 封禁、解封玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;hello from 玩家封禁!&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">run</span><span style="color:#24292E;">()</span></span></code></pre></div></li></ul><h2 id="step-2-处理和获取终端输入" tabindex="-1">Step 2. 处理和获取终端输入 <a class="header-anchor" href="#step-2-处理和获取终端输入" aria-label="Permalink to &quot;Step 2. 处理和获取终端输入&quot;">​</a></h2><ul><li><p>现在, 让我们审视一下自动生成的代码, 很显然, 这一段:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;玩家封禁&quot; </span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[arg1] [arg2] ...&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;玩家封禁&quot; </span><span style="color:#24292E;">},</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[arg1] [arg2] ...&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">})</span></span></code></pre></div><p>描述了一个终端菜单项, 所谓终端菜单项就是输入 ? 唤出的菜单的每一项</p></li><li><p>其中 triggers 为触发词, 一个终端菜单可以具有多个不同的触发词, 满足任意一个都可触发菜单,<br> argument_hint 和 usage 并无实际作用, 但是可以提示如何使用这个菜单项,<br> 现在, 我们将这部分修改如下:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;ban&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;封禁&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;玩家封禁&quot; </span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;ban&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;封禁&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;玩家封禁&quot; </span><span style="color:#24292E;">},</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">})</span></span></code></pre></div></li><li><p>输入 reload, 让修改立即生效, 此时, 再次输入 ? 可以发现, 菜单项变成了 <strong>ban (封禁, 玩家封禁) [玩家名] [时间] [原因]: 从终端封禁玩家</strong>。同时, 当输入 ban 或 封禁 时, 菜单项也可被激活</p></li><li><p>现在, 让我们从输入中读取 玩家名、时间、原因 这三个要素, 将代码扩充为:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;ban&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;封禁&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;玩家封禁&quot; </span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_time</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家 %s %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,ban_time,ban_reason))</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;ban&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;封禁&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;玩家封禁&quot; </span><span style="color:#24292E;">},</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_time</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家 %s %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,ban_time,ban_reason))</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div><p>然后, 输入 reload, 使修改立即生效</p></li><li><p>此时, 输入 <strong>ban 2401PT 1天 测试</strong> 可以发现, 插件正确的获得并显示了我们的指令: <strong>21:10:12 [玩家封禁] 封禁玩家 2401PT 1天, 原因: 测试</strong> 并在日志中记录了该操作</p></li><li><p>但是, 如果不开眼的用户只是输入了 <strong>ban</strong> 没有按提示输入 <strong>[玩家名] [时间] [原因]</strong> 那么, 就会出现: <strong>21:11:55 [玩家封禁] 封禁玩家 nil nil, 原因: nil</strong></p></li><li><p>很显然, 如果用户只输入了 <strong>ban</strong> 我们应该进一步 <strong>交互式</strong> 的询问用户要封禁谁?封禁多久?原因是什么? 而不是简单的报一个错完事, 因为每个人每天都有很多事要做, 记住每一条指令应该长啥样太苛刻了, <strong>符合直觉的使用方式, 并获得符合直觉的结果</strong> 是 neomega 的一个重要的设计准则。回到这里, 在用户没有输入必要的信息时, 我们要向用户询问缺少的信息, 现在, 将代码扩充为:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;ban&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;封禁&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;玩家封禁&quot; </span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的玩家名: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要的时间: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入封禁原因: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家 %s %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, ban_time, ban_reason))</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;ban&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;封禁&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;玩家封禁&quot; </span><span style="color:#24292E;">},</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的玩家名: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        ban_time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要的时间: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;封禁时间不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入封禁原因: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家 %s %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, ban_time, ban_reason))</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div><p>然后, 输入 reload, 使修改立即生效</p></li><li><p>现在试试输入 <strong>ban</strong> , 是不是好使多了?</p></li></ul><h2 id="step-3-处理参数并计算封禁信息" tabindex="-1">Step 3. 处理参数并计算封禁信息 <a class="header-anchor" href="#step-3-处理参数并计算封禁信息" aria-label="Permalink to &quot;Step 3. 处理参数并计算封禁信息&quot;">​</a></h2><ul><li>好的, 既然已经知道了要封禁的时间, 也知道了要封禁谁, 那么让我们开始封禁吧!让我们发出一条 kick 命令, 把这个玩家踢出去:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家 %s %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, ban_time, ban_reason))</span></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,ban_reason),</span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家 %s %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, ban_time, ban_reason))</span></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,ban_reason),</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span></code></pre></div>等一下!是不是哪边好像不太对?这只是把那个玩家踢出去了而已, 那他要是再进来该怎么办?<br> 很简单啊, 把那个玩家再踢出去不就得了?<br> 那他要是隔一天, 隔一个星期, 隔一年再进来, 还要踢吗?<br> 那你肯定要问了, 我们刚刚不是已经获得 ban_time 这个参数了吗?照着ban_time封不就得了?<br> 是的, 确实获得了ban_time这个参数, 但是ban_time究竟是什么?是 &quot;35000&quot;, &quot;1天3小时&quot;, &quot;3d6h19min&quot; 还是别的什么?显然, 无论它是什么, 它都没有指明, 究竟到什么时候为止, 封禁才算结束。</li><li>因此, 我们需要定义一个函数, 完成 ban_time 到具体封禁结束时间的转换:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">take_num_from_string</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(str, unit_names)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- convert &quot;1d2h3m4s&quot; -&gt; 2 by take_num_from_string(&quot;1d2h3m4s&quot;,{ &quot;h&quot;, &quot;H&quot;, &quot;小时&quot;, &quot;时&quot;})</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _, unit_name </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(unit_names) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> num </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">match</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;(%d+)&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> unit_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> num </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(num)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(ban_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- time string can be a single number, or a string like &quot;1d2h3m4s&quot;, or chinese like &quot;1天2小时3分钟4秒&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- try to parse as a single number</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time_num </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(ban_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> time_num </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_num</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;d&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;D&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;天&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">86400</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;h&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;H&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;小时&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;时&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3600</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;m&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;M&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;分钟&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;分&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;s&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;S&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;秒&quot; </span><span style="color:#E1E4E8;">})</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">now</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">time_seconds</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">take_num_from_string</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(str, unit_names)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- convert &quot;1d2h3m4s&quot; -&gt; 2 by take_num_from_string(&quot;1d2h3m4s&quot;,{ &quot;h&quot;, &quot;H&quot;, &quot;小时&quot;, &quot;时&quot;})</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _, unit_name </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(unit_names) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> num </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">match</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;(%d+)&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> unit_name)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> num </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(num)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(ban_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- time string can be a single number, or a string like &quot;1d2h3m4s&quot;, or chinese like &quot;1天2小时3分钟4秒&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- try to parse as a single number</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time_num </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(ban_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> time_num </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_num</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;d&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;D&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;天&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">86400</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;h&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;H&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;小时&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;时&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3600</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;m&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;M&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;分钟&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;分&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;s&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;S&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;秒&quot; </span><span style="color:#24292E;">})</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">now</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">time_seconds</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div>当参数 ban_time 为一个有效的时间时, 函数 ban_time_to_ban_until_time 的返回为一个 unix time stamp, 如果是一个无效的时间, 那么返回为 nil</li><li>接着, 让我们调用这个函数完成封禁时间到封禁截止时间的转换:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;ban&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;封禁&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;玩家封禁&quot; </span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的玩家名: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入封禁原因: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,  </span><span style="color:#79B8FF;">os.date</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span style="color:#E1E4E8;">, ban_until), ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,ban_reason))</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;ban&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;封禁&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;玩家封禁&quot; </span><span style="color:#24292E;">},</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的玩家名: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;封禁时间不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入封禁原因: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,  </span><span style="color:#005CC5;">os.date</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span style="color:#24292E;">, ban_until), ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,ban_reason))</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div></li><li>好的, 现在输入 reload 使修改立刻生效</li><li>让我们尝试一下:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">ban</span></span>
<span class="line"><span style="color:#e1e4e8;">请输入要封禁的玩家名: 2401PT</span></span>
<span class="line"><span style="color:#e1e4e8;">请输入要封禁的时间: 3天2小时</span></span>
<span class="line"><span style="color:#e1e4e8;">请输入封禁原因: 测试</span></span>
<span class="line"><span style="color:#e1e4e8;">16:57:10 [玩家封禁] 封禁玩家: 2401PT 到: 2023-09-06 18:57:08, 原因: 测试</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">ban</span></span>
<span class="line"><span style="color:#24292e;">请输入要封禁的玩家名: 2401PT</span></span>
<span class="line"><span style="color:#24292e;">请输入要封禁的时间: 3天2小时</span></span>
<span class="line"><span style="color:#24292e;">请输入封禁原因: 测试</span></span>
<span class="line"><span style="color:#24292e;">16:57:10 [玩家封禁] 封禁玩家: 2401PT 到: 2023-09-06 18:57:08, 原因: 测试</span></span></code></pre></div>看起来已经顺利工作了</li></ul><h2 id="step-4-监听玩家在线状态变化" tabindex="-1">Step 4. 监听玩家在线状态变化 <a class="header-anchor" href="#step-4-监听玩家在线状态变化" aria-label="Permalink to &quot;Step 4. 监听玩家在线状态变化&quot;">​</a></h2><ul><li>有心的人应该已经发现了, 你这个玩家封禁有问题啊, 你只是在输入 ban 指令的时候将玩家踢出去了一次, 但是那个玩家要是再次上线你该怎么办捏?<br> 当然, 现在可以立刻求证一下是不是这么回事, 那个被封禁的玩家, 只要再上线, 就可以逃过制裁。</li><li>那么该怎么办捏?其实很简单, 既然那个玩家重新上线可以逃过制裁, 那再 kick 他一次不就完事了?</li><li>所以, 我们现在需要让 neomega 在玩家在线状态发生变化的时候执行一段检查该玩家是否被封禁的代码:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_player_change</span><span style="color:#E1E4E8;">():</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(player, action)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- if action == &quot;exist&quot; then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--     coromega:log((&quot;player %s 已经在线&quot;):format(player:name()))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- elseif action == &quot;online&quot; then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--     coromega:log((&quot;player %s 新上线&quot;):format(player:name()))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- elseif action == &quot;offline&quot; then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--     coromega:log((&quot;player %s 下线&quot;):format(player:name()))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> action</span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;">&quot;offline&quot; </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">player</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- coromega:log((&quot;player %s 新上线&quot;):format(player_name))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">player_banned[player_name]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_info.</span><span style="color:#B392F0;">ban_until</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ban_info.</span><span style="color:#B392F0;">ban_reason</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ban_until</span><span style="color:#F97583;">&gt;</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,ban_reason),</span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            player_banned[player_name]</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_player_change</span><span style="color:#24292E;">():</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(player, action)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- if action == &quot;exist&quot; then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--     coromega:log((&quot;player %s 已经在线&quot;):format(player:name()))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- elseif action == &quot;online&quot; then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--     coromega:log((&quot;player %s 新上线&quot;):format(player:name()))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- elseif action == &quot;offline&quot; then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--     coromega:log((&quot;player %s 下线&quot;):format(player:name()))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> action</span><span style="color:#D73A49;">==</span><span style="color:#032F62;">&quot;offline&quot; </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">player</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- coromega:log((&quot;player %s 新上线&quot;):format(player_name))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">player_banned[player_name]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_info.</span><span style="color:#6F42C1;">ban_until</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ban_info.</span><span style="color:#6F42C1;">ban_reason</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ban_until</span><span style="color:#D73A49;">&gt;</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,ban_reason),</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            player_banned[player_name]</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div></li><li>这段函数通过检查新上线的玩家名是否在 player_banned 中, 如果在则进一步判断是否在指定的封禁时间内, 并执行封禁和解封操作, 而 player_banned 则是由终端设置的。因此, 我们需要定义 player_banned 并设置其值:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_banned</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{}</span></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;ban&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;封禁&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;玩家封禁&quot; </span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,  </span><span style="color:#79B8FF;">os.date</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span style="color:#E1E4E8;">, ban_until), ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    player_banned[player_name]</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,ban_reason),</span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_banned</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">{}</span></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;ban&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;封禁&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;玩家封禁&quot; </span><span style="color:#24292E;">},</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,  </span><span style="color:#005CC5;">os.date</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span style="color:#24292E;">, ban_until), ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    player_banned[player_name]</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">        ban_until</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ban_until,</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,ban_reason),</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div></li><li>好的, 现在输入 reload 使修改立刻生效, 这个时候, 就算重新上线也会被立刻踢下线</li></ul><h2 id="step-5-数据库" tabindex="-1">Step 5. 数据库 <a class="header-anchor" href="#step-5-数据库" aria-label="Permalink to &quot;Step 5. 数据库&quot;">​</a></h2><ul><li>但是, 你应该也已经发现一个问题, 就是, 当neoemga重启时, 好像... 封禁又失效了?这是当然的, 因为 刚刚只是把封禁信息存储到一个 变量 里, 然而, 变量会因为 neomega 的关闭或重载丢失。因此, 你需要将封禁信息存储到磁盘中。neomega 实现了一个简单的类似数据库的玩意儿, 可以帮你完成相关信息的存贮。</li><li>首先, 我们需要先创建或者打开一个数据库, 我们希望这个数据库被存储在 磁盘中的: neomega_storage/data/玩家封禁信息 下:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_banned_db</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">key_value_db</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家封禁信息&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_banned_db</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">key_value_db</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家封禁信息&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div></li><li>符合直觉的, 既然我们已经使用了数据库替代了 player_banned 这个变量, 那么自然我们也应该在其他地方用数据库操作进行替代:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 将:</span></span>
<span class="line"><span style="color:#6A737D;">-- player_banned[player_name]={</span></span>
<span class="line"><span style="color:#6A737D;">--     ban_until=ban_until,</span></span>
<span class="line"><span style="color:#6A737D;">--     ban_reason=ban_reason,</span></span>
<span class="line"><span style="color:#6A737D;">-- }</span></span>
<span class="line"><span style="color:#6A737D;">-- 改为:</span></span>
<span class="line"><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(player_name,{</span></span>
<span class="line"><span style="color:#E1E4E8;">    ban_until</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">    ban_reason</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 将:</span></span>
<span class="line"><span style="color:#6A737D;">-- player_banned[player_name]={</span></span>
<span class="line"><span style="color:#6A737D;">--     ban_until=ban_until,</span></span>
<span class="line"><span style="color:#6A737D;">--     ban_reason=ban_reason,</span></span>
<span class="line"><span style="color:#6A737D;">-- }</span></span>
<span class="line"><span style="color:#6A737D;">-- 改为:</span></span>
<span class="line"><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(player_name,{</span></span>
<span class="line"><span style="color:#24292E;">    ban_until</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ban_until,</span></span>
<span class="line"><span style="color:#24292E;">    ban_reason</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">})</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 将:</span></span>
<span class="line"><span style="color:#6A737D;">-- local ban_info=player_banned[player_name]</span></span>
<span class="line"><span style="color:#6A737D;">-- 改为:</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(player_name)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 将:</span></span>
<span class="line"><span style="color:#6A737D;">-- local ban_info=player_banned[player_name]</span></span>
<span class="line"><span style="color:#6A737D;">-- 改为:</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(player_name)</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 将:</span></span>
<span class="line"><span style="color:#6A737D;">-- player_banned[player_name]=nil</span></span>
<span class="line"><span style="color:#6A737D;">-- 改为:</span></span>
<span class="line"><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(player_name)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 将:</span></span>
<span class="line"><span style="color:#6A737D;">-- player_banned[player_name]=nil</span></span>
<span class="line"><span style="color:#6A737D;">-- 改为:</span></span>
<span class="line"><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(player_name)</span></span></code></pre></div></li><li>现在, 即使neoemga重启了, 封禁信息依然有效, 不是吗?</li><li>为了防止你漏掉什么步骤, 到目前为止, 代码看起来应该像这样:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> omega </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;omega&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> json </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;json&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#79B8FF;">package.path</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;%s;%s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">package.path</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    omega.</span><span style="color:#B392F0;">storage_path</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">get_code_path</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;LuaLoader&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;?.lua&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> coromega </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;coromega&quot;</span><span style="color:#E1E4E8;">).</span><span style="color:#79B8FF;">from</span><span style="color:#E1E4E8;">(omega)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;config of 玩家封禁:  &quot;</span><span style="color:#E1E4E8;">,json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">take_num_from_string</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(str, unit_names)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- convert &quot;1d2h3m4s&quot; -&gt; 2 by take_num_from_string(&quot;1d2h3m4s&quot;,{ &quot;h&quot;, &quot;H&quot;, &quot;小时&quot;, &quot;时&quot;})</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _, unit_name </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(unit_names) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> num </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">match</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;(%d+)&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> unit_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> num </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(num)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(ban_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_time</span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- time string can be a single number, or a string like &quot;1d2h3m4s&quot;, or chinese like &quot;1天2小时3分钟4秒&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- try to parse as a single number</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time_num </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(ban_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> time_num </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_num</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;d&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;D&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;天&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">86400</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;h&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;H&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;小时&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;时&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3600</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;m&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;M&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;分钟&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;分&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;s&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;S&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;秒&quot; </span><span style="color:#E1E4E8;">})</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">now</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">time_seconds</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_banned_db</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">key_value_db</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家封禁信息&quot;</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;ban&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;封禁&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;玩家封禁&quot; </span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的玩家名: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入封禁原因: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,  </span><span style="color:#79B8FF;">os.date</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span style="color:#E1E4E8;">, ban_until), ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(player_name,{</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,ban_reason),</span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_player_change</span><span style="color:#E1E4E8;">():</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(player, action)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> action</span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;">&quot;offline&quot; </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">player</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_info.</span><span style="color:#B392F0;">ban_until</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ban_info.</span><span style="color:#B392F0;">ban_reason</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ban_until</span><span style="color:#F97583;">&gt;</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,ban_reason),</span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">run</span><span style="color:#E1E4E8;">()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> omega </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;omega&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> json </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;json&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">package.path</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;%s;%s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">package.path</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    omega.</span><span style="color:#6F42C1;">storage_path</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">get_code_path</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;LuaLoader&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;?.lua&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> coromega </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;coromega&quot;</span><span style="color:#24292E;">).</span><span style="color:#005CC5;">from</span><span style="color:#24292E;">(omega)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;config of 玩家封禁:  &quot;</span><span style="color:#24292E;">,json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">take_num_from_string</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(str, unit_names)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- convert &quot;1d2h3m4s&quot; -&gt; 2 by take_num_from_string(&quot;1d2h3m4s&quot;,{ &quot;h&quot;, &quot;H&quot;, &quot;小时&quot;, &quot;时&quot;})</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _, unit_name </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(unit_names) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> num </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">match</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;(%d+)&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> unit_name)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> num </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(num)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(ban_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_time</span><span style="color:#D73A49;">==</span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- time string can be a single number, or a string like &quot;1d2h3m4s&quot;, or chinese like &quot;1天2小时3分钟4秒&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- try to parse as a single number</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time_num </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(ban_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> time_num </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_num</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;d&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;D&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;天&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">86400</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;h&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;H&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;小时&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;时&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3600</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;m&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;M&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;分钟&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;分&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;s&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;S&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;秒&quot; </span><span style="color:#24292E;">})</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">now</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">time_seconds</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_banned_db</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">key_value_db</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家封禁信息&quot;</span><span style="color:#24292E;">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;ban&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;封禁&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;玩家封禁&quot; </span><span style="color:#24292E;">},</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的玩家名: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;封禁时间不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入封禁原因: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,  </span><span style="color:#005CC5;">os.date</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span style="color:#24292E;">, ban_until), ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(player_name,{</span></span>
<span class="line"><span style="color:#24292E;">        ban_until</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ban_until,</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,ban_reason),</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_player_change</span><span style="color:#24292E;">():</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(player, action)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> action</span><span style="color:#D73A49;">==</span><span style="color:#032F62;">&quot;offline&quot; </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">player</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_info.</span><span style="color:#6F42C1;">ban_until</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ban_info.</span><span style="color:#6F42C1;">ban_reason</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ban_until</span><span style="color:#D73A49;">&gt;</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,ban_reason),</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">run</span><span style="color:#24292E;">()</span></span></code></pre></div></li></ul><h2 id="step-6-配置文件和显示优化" tabindex="-1">Step 6. 配置文件和显示优化: <a class="header-anchor" href="#step-6-配置文件和显示优化" aria-label="Permalink to &quot;Step 6. 配置文件和显示优化:&quot;">​</a></h2><ul><li><p>在我们进行下一步前, 让我们针对这几个小问题进行一点小小的优化:</p><ul><li>我不想要这个定死的触发词, 我希望它的触发词像其他的 neomega 组件那样可以修改, 因为那样很酷</li><li>被封禁的玩家在被踢出时, 显示的仅仅是&quot;您已被踢出游戏&quot;。如果能显示更多的细节那会更好</li><li>当被封禁玩家上线时, 它们看到的仅仅是 &quot;服务器断开连接&quot; 而不是具体的封禁信息, 那样不好</li></ul></li><li><p>当然, 如果你能一路看到这边, 然后写出这一百多行代码, 你还算的上有点耐心。也许你会觉得, 啊?我以为很简单的这点功能写起来这么麻烦?哈哈, 这才哪儿到哪儿啊。 上述这三个问题都是非常细节的问题, 而一个组件是否好用往往取决于细节方面处理的细致程度。</p></li><li><p>让我们从第一个问题开始, 如何从配置中获得触发词并应用触发词捏? 很简单, 配置文件(就是那个json)中的配置会被 neomega 自动转换并放在 coromega.config 中以供调用, 所以我们只要:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;触发词&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;触发词&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">})</span></span></code></pre></div><p>即可。<br> 好的, 让我们输入 reload 使配置立即生效。<br> 阿勒? 什么情况?<br> lua 插件: 玩家封禁.lua 出现错误:<br> interface conversion: lua.LValue is *lua.LNilType, not *lua.LTable<br> 很显然, config 中并没有这一项(触发词)。你也许会说, 那在配置文件中填充这一项不就得了嘛?<br> 这当然是可以的, 但是如果你以后代码要升级, 需要新的配置, 或用户粗心大意, 漏了这个配置要怎么办捏?<br> 因此, 我们可以在缺少这个配置的情况下, 主动写入这个配置:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.1&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;触发词&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;ban&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;玩家封禁&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;封禁玩家&quot; </span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;触发词&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.1&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;触发词&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;ban&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;玩家封禁&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;封禁玩家&quot; </span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.2&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;触发词&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><p>这一段的含义是, 如果配置文件的版本号为 0.0.1 就写入新的配置项, 并升级版本号<br> 让我们输入 reload, 看看配置文件发生了什么变化:<br> 这是之前的配置文件:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;名称&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;玩家封禁.lua&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;描述&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;是否禁用&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;来源&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;LuaLoader&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;配置&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&quot;Version&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;0.0.1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;名称&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;玩家封禁.lua&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;描述&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;是否禁用&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;来源&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;LuaLoader&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;配置&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;Version&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;0.0.1&quot;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>这是reload之后, 自动升级的配置文件:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;名称&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;玩家封禁.lua&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;配置&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&quot;Version&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;0.0.2&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&quot;触发词&quot;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;ban&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;玩家封禁&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;封禁玩家&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        ]</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;描述&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;是否禁用&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;来源&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;LuaLoader&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;名称&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;玩家封禁.lua&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;配置&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;Version&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;0.0.2&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;触发词&quot;</span><span style="color:#24292E;">: [</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;ban&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;玩家封禁&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;封禁玩家&quot;</span></span>
<span class="line"><span style="color:#24292E;">        ]</span></span>
<span class="line"><span style="color:#24292E;">    },</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;描述&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;是否禁用&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;来源&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;LuaLoader&quot;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>让我们输入 ? 看看菜单有没有正确的修改捏?</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">ban (玩家封禁, 封禁玩家) [玩家名] [时间] [原因]: 从终端封禁玩家</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">ban (玩家封禁, 封禁玩家) [玩家名] [时间] [原因]: 从终端封禁玩家</span></span></code></pre></div><p>good, 怎么样, 还是很方便的吧?</p></li><li><p>那么接下来第二个问题, 还是类似的, 我们留出一个配置项让用户自己决定被踢出玩家的提示 (注意不要撞上网易的敏感词了) :</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.2&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;被踢出时的提示信息&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;您因为 [ban_reason] 被封禁到 [ban_until]&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;日期显示格式&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;%Y-%m-%d %H:%M:%S&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.3&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> hint_format </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;被踢出时的提示信息&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> date_time_format </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;日期显示格式&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(unix_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">os.date</span><span style="color:#E1E4E8;">(date_time_format, unix_time)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> hint_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> hint_format</span></span>
<span class="line"><span style="color:#E1E4E8;">    hint_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hint_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%[ban_reason%]&quot;</span><span style="color:#E1E4E8;">, ban_reason)</span></span>
<span class="line"><span style="color:#E1E4E8;">    hint_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hint_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%[ban_until%]&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> hint_str</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.2&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;被踢出时的提示信息&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;您因为 [ban_reason] 被封禁到 [ban_until]&quot;</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;日期显示格式&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;%Y-%m-%d %H:%M:%S&quot;</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.3&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> hint_format </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;被踢出时的提示信息&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> date_time_format </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;日期显示格式&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unix_time_to_date_time_str</span><span style="color:#24292E;">(unix_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">os.date</span><span style="color:#24292E;">(date_time_format, unix_time)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> hint_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hint_format</span></span>
<span class="line"><span style="color:#24292E;">    hint_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hint_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%[ban_reason%]&quot;</span><span style="color:#24292E;">, ban_reason)</span></span>
<span class="line"><span style="color:#24292E;">    hint_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hint_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%[ban_until%]&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> hint_str</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><p>然后</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 将</span></span>
<span class="line"><span style="color:#6A737D;">-- coromega:send_ws_cmd((&quot;kick %s %s&quot;):format(player_name, ban_reason), false)</span></span>
<span class="line"><span style="color:#6A737D;">-- 改为 </span></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until,ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 将</span></span>
<span class="line"><span style="color:#6A737D;">-- coromega:send_ws_cmd((&quot;kick %s %s&quot;):format(player_name, ban_reason), false)</span></span>
<span class="line"><span style="color:#6A737D;">-- 改为 </span></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until,ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span></code></pre></div><p>好的, 让我们输入 reload 使修改立刻生效, 现在再试试, 正常显示了吧?</p></li><li><p>最后, 是第三个问题, 为什么当被封禁玩家上线时, 它们看到的仅仅是 &quot;服务器断开连接&quot; 而不是具体的封禁信息?因为, neomega 的反应过于迅速, 这使得玩家被踢的过早, 以至于无法显示出这条提示信息。想要解决也很简单, 只需要等待被封禁的玩家上线几秒钟, 再踢出即可。但是, 问题在于, 有的用户希望被封禁玩家立刻被踢掉, 而不是只为了显示一个原因冒着风险等几秒再踢。<br> 这个问题也很好解决, 我们只需要再添加一个配置项, 让用户自行决定即可:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.3&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.4&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ensure_hint_display </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.3&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.4&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ensure_hint_display </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ensure_hint_display </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4.0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ensure_hint_display </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sleep</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">4.0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span></code></pre></div><p>好的, 让我们现在输入 reload 使修改立刻生效。如何?显示正常了吧?</p></li><li><p>为了防止你错过其中的某个步骤, 到目前为止, 代码看起来应该是这样</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> omega </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;omega&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> json </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;json&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#79B8FF;">package.path</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;%s;%s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">package.path</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    omega.</span><span style="color:#B392F0;">storage_path</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">get_code_path</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;LuaLoader&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;?.lua&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> coromega </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;coromega&quot;</span><span style="color:#E1E4E8;">).</span><span style="color:#79B8FF;">from</span><span style="color:#E1E4E8;">(omega)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;config of 玩家封禁:  &quot;</span><span style="color:#E1E4E8;">, json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">take_num_from_string</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(str, unit_names)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- convert &quot;1d2h3m4s&quot; -&gt; 2 by take_num_from_string(&quot;1d2h3m4s&quot;,{ &quot;h&quot;, &quot;H&quot;, &quot;小时&quot;, &quot;时&quot;})</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _, unit_name </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(unit_names) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> num </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">match</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;(%d+)&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> unit_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> num </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(num)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(ban_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- time string can be a single number, or a string like &quot;1d2h3m4s&quot;, or chinese like &quot;1天2小时3分钟4秒&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- try to parse as a single number</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time_num </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(ban_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> time_num </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_num</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;d&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;D&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;天&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">86400</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;h&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;H&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;小时&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;时&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3600</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;m&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;M&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;分钟&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;分&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;s&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;S&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;秒&quot; </span><span style="color:#E1E4E8;">})</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> time_seconds</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_banned_db </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">key_value_db</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家封禁信息&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.1&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;触发词&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;ban&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;玩家封禁&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;封禁玩家&quot; </span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;触发词&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.2&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;被踢出时的提示信息&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;您因为 [ban_reason] 被封禁到 [ban_until]&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;日期显示格式&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;%Y-%m-%d %H:%M:%S&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.3&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> hint_format </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;被踢出时的提示信息&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> date_time_format </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;日期显示格式&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(unix_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">os.date</span><span style="color:#E1E4E8;">(date_time_format, unix_time)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> hint_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> hint_format</span></span>
<span class="line"><span style="color:#E1E4E8;">    hint_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hint_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%[ban_reason%]&quot;</span><span style="color:#E1E4E8;">, ban_reason)</span></span>
<span class="line"><span style="color:#E1E4E8;">    hint_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hint_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%[ban_until%]&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> hint_str</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.3&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.4&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ensure_hint_display </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的玩家名: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入封禁原因: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(player_name, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_player_change</span><span style="color:#E1E4E8;">():</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(player, action)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> action </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;offline&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_info.</span><span style="color:#B392F0;">ban_until</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_info.</span><span style="color:#B392F0;">ban_reason</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ensure_hint_display </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4.0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">run</span><span style="color:#E1E4E8;">()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> omega </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;omega&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> json </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;json&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">package.path</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;%s;%s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">package.path</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    omega.</span><span style="color:#6F42C1;">storage_path</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">get_code_path</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;LuaLoader&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;?.lua&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> coromega </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;coromega&quot;</span><span style="color:#24292E;">).</span><span style="color:#005CC5;">from</span><span style="color:#24292E;">(omega)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;config of 玩家封禁:  &quot;</span><span style="color:#24292E;">, json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">take_num_from_string</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(str, unit_names)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- convert &quot;1d2h3m4s&quot; -&gt; 2 by take_num_from_string(&quot;1d2h3m4s&quot;,{ &quot;h&quot;, &quot;H&quot;, &quot;小时&quot;, &quot;时&quot;})</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _, unit_name </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(unit_names) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> num </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">match</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;(%d+)&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> unit_name)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> num </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(num)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(ban_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- time string can be a single number, or a string like &quot;1d2h3m4s&quot;, or chinese like &quot;1天2小时3分钟4秒&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- try to parse as a single number</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time_num </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(ban_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> time_num </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_num</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;d&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;D&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;天&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">86400</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;h&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;H&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;小时&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;时&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3600</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;m&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;M&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;分钟&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;分&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;s&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;S&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;秒&quot; </span><span style="color:#24292E;">})</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> time_seconds</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_banned_db </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">key_value_db</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家封禁信息&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.1&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;触发词&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;ban&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;玩家封禁&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;封禁玩家&quot; </span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.2&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;触发词&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.2&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;被踢出时的提示信息&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;您因为 [ban_reason] 被封禁到 [ban_until]&quot;</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;日期显示格式&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;%Y-%m-%d %H:%M:%S&quot;</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.3&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> hint_format </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;被踢出时的提示信息&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> date_time_format </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;日期显示格式&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unix_time_to_date_time_str</span><span style="color:#24292E;">(unix_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">os.date</span><span style="color:#24292E;">(date_time_format, unix_time)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> hint_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hint_format</span></span>
<span class="line"><span style="color:#24292E;">    hint_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hint_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%[ban_reason%]&quot;</span><span style="color:#24292E;">, ban_reason)</span></span>
<span class="line"><span style="color:#24292E;">    hint_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hint_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%[ban_until%]&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> hint_str</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.3&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.4&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ensure_hint_display </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的玩家名: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;封禁时间不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入封禁原因: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(player_name, {</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_until,</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_player_change</span><span style="color:#24292E;">():</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(player, action)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> action </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;offline&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_info.</span><span style="color:#6F42C1;">ban_until</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_info.</span><span style="color:#6F42C1;">ban_reason</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ensure_hint_display </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sleep</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">4.0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">run</span><span style="color:#24292E;">()</span></span></code></pre></div></li></ul><h2 id="step-7-添加第二个终端菜单" tabindex="-1">Step 7. 添加第二个终端菜单 <a class="header-anchor" href="#step-7-添加第二个终端菜单" aria-label="Permalink to &quot;Step 7. 添加第二个终端菜单&quot;">​</a></h2><ul><li>有了上述的知识之后, 添加一个解封的终端菜单显然不是一件难事, 让我们添加这一段代码:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.4&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;解封触发词&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;unban&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;玩家解封&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;解封玩家&quot; </span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.5&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> unban_triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;解封触发词&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> unban_triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端解封玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要解封的玩家名: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.4&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;解封触发词&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;unban&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;玩家解封&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;解封玩家&quot; </span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.5&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> unban_triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;解封触发词&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> unban_triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端解封玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要解封的玩家名: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div>好的, 输入reload, 让修改立刻生效, 如果你感到困难, 你应该回头看看之前的步骤。</li></ul><h1 id="step-8-添加游戏内菜单" tabindex="-1">Step 8. 添加游戏内菜单 <a class="header-anchor" href="#step-8-添加游戏内菜单" aria-label="Permalink to &quot;Step 8. 添加游戏内菜单&quot;">​</a></h1><ul><li>经过上面的一系列步骤, 这个玩家封禁组件已经是一个可用的组件了。但是从这一步开始, coromega 真正的秘密才刚刚要被揭开</li><li>首先, 让我们添加一个游戏内菜单, 可以注意到, 游戏内菜单添加方法和终端菜单非常接近。那是当然的, 设计成这样才能让人更好的上手不是吗?<br> 不过略有不同的是, 输入的参数不再只是 input, 而是一个复杂的结构: chat。chat 中包含了比较多的信息, 可以使用 json.encode(chat) 查看。不过, 我们要关心的主要是俩: chat.msg (和input差不多的东西), chat.name 发送消息的玩家名。<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_game_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从游戏内封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(chat)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 如果你希望, 可以这样查看chat内包含的信息:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(chat))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">name</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> input </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">msg</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(caller_name, json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(input)))</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_game_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从游戏内封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(chat)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 如果你希望, 可以这样查看chat内包含的信息:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(chat))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">name</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">msg</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(caller_name, json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(input)))</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div>在你输入reload并测试这个菜单项的时候, 你应该发现了两个现象: <ol><li>这个菜单项并没有出现在默认菜单里, 而是出现在默认菜单下的 &quot;创造菜单&quot; 中(如果你没有调整过omega的设置), 而且, 这个菜单项不是所有人都可以调用的<br> 这是因为, 菜单项所在的位置和权限全部由 &quot;neomega_storage/config/neomega框架配置.json&quot; 决定, 你应该在那个文件中调整菜单项的位置和配置</li><li>print (当然log也一样) 输出的信息仍然位于终端, 而不是游戏里。但是你希望的是与玩家进行交互, 比如询问玩家一些信息或者向他发送信息。而这正是 neomega 一个重点支持的功能, 请看下一步。</li></ol></li></ul><h2 id="step-9-与玩家交互" tabindex="-1">Step 9. 与玩家交互 <a class="header-anchor" href="#step-9-与玩家交互" aria-label="Permalink to &quot;Step 9. 与玩家交互&quot;">​</a></h2><ul><li>首先, 需要明确的一点是, 如果你用命令的形式和玩家交互(比如 tellraw)之类的是没有一点问题的。但是, 你无法通过这个途径获得关于玩家的更多信息, 比如他的id, 上线时间, 权限等等信息 (关于具体有哪些api和功能, 你稍后可以自行看玩家交互相关文档) 。这里我们演示如何与玩家交流:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_game_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从游戏内封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(chat)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 如果你希望, 可以这样查看chat内包含的信息:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(chat))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">name</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> input </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">msg</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(caller_name, json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(input)))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get_player_by_name</span><span style="color:#E1E4E8;">(caller_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">is_op</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;调用者是 OP&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">-- 实际没必要, 因为菜单已经做了权限控制, 这里只是为了向你展示 coromega 的 player 对象可以做到命令做不到的事</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;抱歉, 你不是 OP&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的玩家名: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入封禁原因: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ban_player_name, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_game_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从游戏内封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(chat)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 如果你希望, 可以这样查看chat内包含的信息:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(chat))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">name</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">msg</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(caller_name, json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(input)))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get_player_by_name</span><span style="color:#24292E;">(caller_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">is_op</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;调用者是 OP&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">-- 实际没必要, 因为菜单已经做了权限控制, 这里只是为了向你展示 coromega 的 player 对象可以做到命令做不到的事</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;抱歉, 你不是 OP&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的玩家名: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;封禁时间不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入封禁原因: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ban_player_name, {</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_until,</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div>现在, 输入 reload 测试一下。 很方便也很直观, 不是吗?neomega 和 coromega 在背后做了大量的工作, 使得可以轻易的编写出符合直觉且功能强大的代码</li></ul><h2 id="step-x" tabindex="-1">Step X. <a class="header-anchor" href="#step-x" aria-label="Permalink to &quot;Step X.&quot;">​</a></h2><ul><li>太好了, 这刚好是第 X 步。<br> 罗马数字 X ... 很适合以此为标题揭露一些有趣的秘密。</li><li>你有没有想过, 如果当一个玩家唤起菜单, 且当omega正在询问他信息或者与他交流时, 如果另一个玩家也唤起了菜单, 或者你自己在终端正在输入, 那么会怎么样呢? 如果你此前没有任何代码经验的话, 你大概会觉得不明所以。是啊?所以会怎么样呢?<br> 但是, 如果你此前有任何代码经验, 你大概会顿感不妙。天呐, 程序该不会卡住吧?你这么想到, 因为你很清楚, 当程序运行到 input, ask, sleep 这种地方时, 程序就会停下来等待输入或者时间到达, 这时候如果有别的事件, 比如另一个玩家唤起菜单, 程序就会卡住...吗?</li><li>神奇的是, 你测试了一下, 发现这种事情并没有发生, 但这是为什么呢?</li><li>这就是 coromega 背后的秘密, 也是它为什么叫 coro-omega 的原因。注意到 start_new 这个函数了吗?有没有考虑过, start_new 的究竟是什么呢?</li><li>答案是, start_new 的是一个 coroutine, coroutine 是一个远比线程轻的东西, 它和普通的函数调用几乎没有任何区别...但是代价是什么?代价是, coroutine必须主动让出执行权, 而这会使得程序变得异常复杂...</li><li>而 coromega 则在背后做了大量的工作, coromega:run() 隐藏了这些复杂的细节, 并将异步, 回调, 以及复杂的协程编程用一种简单的方式提供... 你只需要记得 start_new 的是一个 协程 , 而当协程内的程序运行到需要等待的函数 (input, ask, sleep, send_ws/player_cmd, http... 等等) 的时候, 这个协程就会被自动挂起, 并执行其他协程, 直到结果返回。它用起来比线程简单, 性能比线程好, 而代价 (编程的困难) 则由 coromega 支付</li></ul><h2 id="step-11-第二个游戏内菜单" tabindex="-1">Step 11. 第二个游戏内菜单 <a class="header-anchor" href="#step-11-第二个游戏内菜单" aria-label="Permalink to &quot;Step 11. 第二个游戏内菜单&quot;">​</a></h2><ul><li>有了之前的经验, 这一步应该会很容易, 插入这段代码即可:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_game_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> unban_triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从游戏内解封玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(chat)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">name</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> input </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">msg</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(caller_name, json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(input)))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get_player_by_name</span><span style="color:#E1E4E8;">(caller_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要解封的玩家名: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(ban_player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(ban_player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_game_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> unban_triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从游戏内解封玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(chat)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">name</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">msg</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(caller_name, json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(input)))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get_player_by_name</span><span style="color:#24292E;">(caller_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要解封的玩家名: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(ban_player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(ban_player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div>让我们输入 reload, 然后再测试一下, 看, 很容易吧?</li></ul><h2 id="step-12-优化玩家输入体验" tabindex="-1">Step 12. 优化玩家输入体验 <a class="header-anchor" href="#step-12-优化玩家输入体验" aria-label="Permalink to &quot;Step 12. 优化玩家输入体验&quot;">​</a></h2><ul><li>想必你一定注意到了, 总是有玩家会用一些非常讨厌的, 无法输入的名字。那么有没有办法优化玩家名输入体验捏? 很简单, 我们可以添加这么一个函数 (看不懂也没关系, 这是可选的) :<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(disp)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> candidates </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get_all_online_players</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> selectable_candidates </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i, candidate </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(candidates) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> idx </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;%s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(i)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">candidate</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">        selectable_candidates[idx] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> name</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">disp</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;%s: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(idx, name))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(selection)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> seleted_candidate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> selectable_candidates[selection]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> seleted_candidate </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> seleted_candidate</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> selection</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(disp)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> candidates </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get_all_online_players</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> selectable_candidates </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i, candidate </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(candidates) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> idx </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;%s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(i)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">candidate</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">        selectable_candidates[idx] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> name</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">disp</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;%s: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(idx, name))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(selection)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> seleted_candidate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> selectable_candidates[selection]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> seleted_candidate </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> seleted_candidate</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> selection</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div>然后修改对应的部分<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- player_name = coromega:input(&quot;请输入要封禁的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resolver </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(info) </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(info) </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">resolver</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的玩家名, 或输入序号: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- player_name = coromega:input(&quot;请输入要封禁的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resolver </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(info) </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(info) </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">resolver</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的玩家名, 或输入序号: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- player_name = coromega:input(&quot;请输入要解封的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resolver </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(info) </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(info) </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">resolver</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要解封的玩家名, 或输入序号: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- player_name = coromega:input(&quot;请输入要解封的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resolver </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(info) </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(info) </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">resolver</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要解封的玩家名, 或输入序号: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- ban_player_name = caller:ask(&quot;请输入要封禁的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resolver </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(info) </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(info) </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">resolver</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的玩家名, 或输入序号: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- ban_player_name = caller:ask(&quot;请输入要封禁的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resolver </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(info) </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(info) </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">resolver</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的玩家名, 或输入序号: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- ban_player_name = caller:ask(&quot;请输入要解封的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resolver </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(info) </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(info) </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">resolver</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要解封的玩家名, 或输入序号: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- ban_player_name = caller:ask(&quot;请输入要解封的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resolver </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(info) </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(info) </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">resolver</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要解封的玩家名, 或输入序号: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div>输入 reload 然后观察变化, 是不是挺好使的?</li></ul><h2 id="step-13-checkpoint" tabindex="-1">Step 13. Checkpoint <a class="header-anchor" href="#step-13-checkpoint" aria-label="Permalink to &quot;Step 13. Checkpoint&quot;">​</a></h2><ul><li>到这步为止, 一个合格的组件就制作完了。在这篇教程里还准备了一点别的, 比如如何从 QQ、命令块、或者从别的组件唤起。这些内容将写在 Step 14 ~ 文末</li><li>为了防止你漏掉了什么, 到目前为止, 整个代码应该看起来像这样:</li></ul><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> omega </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;omega&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> json </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;json&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#79B8FF;">package.path</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;%s;%s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">package.path</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    omega.</span><span style="color:#B392F0;">storage_path</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">get_code_path</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;LuaLoader&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;?.lua&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> coromega </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;coromega&quot;</span><span style="color:#E1E4E8;">).</span><span style="color:#79B8FF;">from</span><span style="color:#E1E4E8;">(omega)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;config of 玩家封禁:  &quot;</span><span style="color:#E1E4E8;">, json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">take_num_from_string</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(str, unit_names)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- convert &quot;1d2h3m4s&quot; -&gt; 2 by take_num_from_string(&quot;1d2h3m4s&quot;,{ &quot;h&quot;, &quot;H&quot;, &quot;小时&quot;, &quot;时&quot;})</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _, unit_name </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(unit_names) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> num </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">match</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;(%d+)&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> unit_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> num </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(num)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(ban_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- time string can be a single number, or a string like &quot;1d2h3m4s&quot;, or chinese like &quot;1天2小时3分钟4秒&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- try to parse as a single number</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time_num </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(ban_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> time_num </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_num</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;d&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;D&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;天&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">86400</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;h&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;H&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;小时&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;时&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3600</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;m&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;M&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;分钟&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;分&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;s&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;S&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;秒&quot; </span><span style="color:#E1E4E8;">})</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> time_seconds</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_banned_db </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">key_value_db</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家封禁信息&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.1&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;触发词&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;ban&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;玩家封禁&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;封禁玩家&quot; </span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;触发词&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.2&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;被踢出时的提示信息&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;您因为 [ban_reason] 被封禁到 [ban_until]&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;日期显示格式&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;%Y-%m-%d %H:%M:%S&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.3&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> hint_format </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;被踢出时的提示信息&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> date_time_format </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;日期显示格式&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(unix_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">os.date</span><span style="color:#E1E4E8;">(date_time_format, unix_time)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> hint_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> hint_format</span></span>
<span class="line"><span style="color:#E1E4E8;">    hint_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hint_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%[ban_reason%]&quot;</span><span style="color:#E1E4E8;">, ban_reason)</span></span>
<span class="line"><span style="color:#E1E4E8;">    hint_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hint_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%[ban_until%]&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> hint_str</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.3&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.4&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ensure_hint_display </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(disp)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> candidates </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get_all_online_players</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> selectable_candidates </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i, candidate </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(candidates) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> idx </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;%s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(i)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">candidate</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">        selectable_candidates[idx] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> name</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">disp</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;%s: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(idx, name))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(selection)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> seleted_candidate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> selectable_candidates[selection]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> seleted_candidate </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> seleted_candidate</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> selection</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resolver </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(info) </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(info) </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">resolver</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的玩家名, 或输入序号: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入封禁原因: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(player_name, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.4&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;解封触发词&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;unban&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;玩家解封&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;解封玩家&quot; </span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.5&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> unban_triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;解封触发词&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> unban_triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端解封玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resolver </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(info) </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(info) </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">resolver</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要解封的玩家名, 或输入序号: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_game_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从游戏内封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(chat)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 如果你希望, 可以这样查看chat内包含的信息:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- print(json.encode(chat))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">name</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> input </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">msg</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- print((&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;):format(caller_name, json.encode(input)))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get_player_by_name</span><span style="color:#E1E4E8;">(caller_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- if caller:is_op() then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--     print(&quot;调用者是 OP&quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- else</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--     -- 实际没必要, 因为菜单已经做了权限控制, 这里只是为了向你展示 coromega 的 player 对象可以做到命令做不到的事</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--     caller:say(&quot;抱歉, 你不是 OP&quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">-- ban_player_name = caller:ask(&quot;请输入要封禁的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resolver </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(info) </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(info) </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">resolver</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的玩家名, 或输入序号: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入封禁原因: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ban_player_name, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_game_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> unban_triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从游戏内解封玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(chat)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">name</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> input </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">msg</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(caller_name, json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(input)))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get_player_by_name</span><span style="color:#E1E4E8;">(caller_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">-- ban_player_name = caller:ask(&quot;请输入要解封的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resolver </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(info) </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(info) </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">resolver</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要解封的玩家名, 或输入序号: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(ban_player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(ban_player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_player_change</span><span style="color:#E1E4E8;">():</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(player, action)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> action </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;offline&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_info.</span><span style="color:#B392F0;">ban_until</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_info.</span><span style="color:#B392F0;">ban_reason</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ensure_hint_display </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4.0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">run</span><span style="color:#E1E4E8;">()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> omega </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;omega&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> json </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;json&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">package.path</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;%s;%s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">package.path</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    omega.</span><span style="color:#6F42C1;">storage_path</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">get_code_path</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;LuaLoader&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;?.lua&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> coromega </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;coromega&quot;</span><span style="color:#24292E;">).</span><span style="color:#005CC5;">from</span><span style="color:#24292E;">(omega)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;config of 玩家封禁:  &quot;</span><span style="color:#24292E;">, json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">take_num_from_string</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(str, unit_names)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- convert &quot;1d2h3m4s&quot; -&gt; 2 by take_num_from_string(&quot;1d2h3m4s&quot;,{ &quot;h&quot;, &quot;H&quot;, &quot;小时&quot;, &quot;时&quot;})</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _, unit_name </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(unit_names) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> num </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">match</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;(%d+)&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> unit_name)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> num </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(num)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(ban_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- time string can be a single number, or a string like &quot;1d2h3m4s&quot;, or chinese like &quot;1天2小时3分钟4秒&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- try to parse as a single number</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time_num </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(ban_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> time_num </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_num</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;d&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;D&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;天&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">86400</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;h&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;H&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;小时&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;时&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3600</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;m&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;M&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;分钟&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;分&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;s&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;S&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;秒&quot; </span><span style="color:#24292E;">})</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> time_seconds</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_banned_db </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">key_value_db</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家封禁信息&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.1&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;触发词&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;ban&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;玩家封禁&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;封禁玩家&quot; </span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.2&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;触发词&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.2&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;被踢出时的提示信息&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;您因为 [ban_reason] 被封禁到 [ban_until]&quot;</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;日期显示格式&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;%Y-%m-%d %H:%M:%S&quot;</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.3&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> hint_format </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;被踢出时的提示信息&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> date_time_format </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;日期显示格式&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unix_time_to_date_time_str</span><span style="color:#24292E;">(unix_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">os.date</span><span style="color:#24292E;">(date_time_format, unix_time)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> hint_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hint_format</span></span>
<span class="line"><span style="color:#24292E;">    hint_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hint_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%[ban_reason%]&quot;</span><span style="color:#24292E;">, ban_reason)</span></span>
<span class="line"><span style="color:#24292E;">    hint_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hint_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%[ban_until%]&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> hint_str</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.3&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.4&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ensure_hint_display </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(disp)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> candidates </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get_all_online_players</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> selectable_candidates </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i, candidate </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(candidates) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> idx </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;%s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(i)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">candidate</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">        selectable_candidates[idx] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> name</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">disp</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;%s: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(idx, name))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(selection)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> seleted_candidate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> selectable_candidates[selection]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> seleted_candidate </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> seleted_candidate</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> selection</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resolver </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(info) </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(info) </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">resolver</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的玩家名, 或输入序号: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;封禁时间不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入封禁原因: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(player_name, {</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_until,</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.4&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;解封触发词&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;unban&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;玩家解封&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;解封玩家&quot; </span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.5&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> unban_triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;解封触发词&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> unban_triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端解封玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resolver </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(info) </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(info) </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">resolver</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要解封的玩家名, 或输入序号: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_game_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从游戏内封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(chat)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 如果你希望, 可以这样查看chat内包含的信息:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- print(json.encode(chat))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">name</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">msg</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- print((&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;):format(caller_name, json.encode(input)))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get_player_by_name</span><span style="color:#24292E;">(caller_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- if caller:is_op() then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--     print(&quot;调用者是 OP&quot;)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- else</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--     -- 实际没必要, 因为菜单已经做了权限控制, 这里只是为了向你展示 coromega 的 player 对象可以做到命令做不到的事</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--     caller:say(&quot;抱歉, 你不是 OP&quot;)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">-- ban_player_name = caller:ask(&quot;请输入要封禁的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resolver </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(info) </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(info) </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">resolver</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的玩家名, 或输入序号: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;封禁时间不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入封禁原因: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ban_player_name, {</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_until,</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_game_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> unban_triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从游戏内解封玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(chat)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">name</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">msg</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(caller_name, json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(input)))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get_player_by_name</span><span style="color:#24292E;">(caller_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">-- ban_player_name = caller:ask(&quot;请输入要解封的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resolver </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(info) </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(info) </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">resolver</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要解封的玩家名, 或输入序号: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(ban_player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(ban_player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_player_change</span><span style="color:#24292E;">():</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(player, action)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> action </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;offline&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_info.</span><span style="color:#6F42C1;">ban_until</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_info.</span><span style="color:#6F42C1;">ban_reason</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ensure_hint_display </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sleep</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">4.0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">run</span><span style="color:#24292E;">()</span></span></code></pre></div><h2 id="step-14-从命令块封禁玩家" tabindex="-1">Step 14. 从命令块封禁玩家 <a class="header-anchor" href="#step-14-从命令块封禁玩家" aria-label="Permalink to &quot;Step 14. 从命令块封禁玩家&quot;">​</a></h2><ul><li>用命令块调用机器人封禁玩家应该算是本教程中最简单的部分了。</li><li>准备两个命令块, 名字填为 #ban (#最好不要丢)。</li><li>#ban 命令块 里面的内容填为 tell @a[tag=omega_bot] 玩家名(例如 @p[tag=ban]) 时间(例如1d) 原因(例如测试)。看起来像这样 tell @a[tag=omega_bot] @p[tag=ban] 1d 测试 。需要注意的是, 应该用 @p 而不是 @a, 同时, 如果用的是循环命令方块, 频率不要太高, 不然可能会卡(40,60,80等等较为合适)</li><li>虽然因为机器人会把被封禁的玩家踢下线导致命令块无法用上述方式发送解封指令 (除非你把频率调的很高, 但那样会卡) , 但是如果你修改程序, 使得机器人在玩家上线一会儿之后才踢人, 那也是可以做的, 只是没什么意义</li><li>最后, 如果命令块的内容类似于 execute @e[type=snowball] ~ ~ ~ tell @a[tag=omega_bot] @p[r=3], 那么应当监听物品名 (coromega:when_receive_msg_from_sender_named) 而不是命令方块名 (coromega:when_receive_msg_from_command_block_named) 因为 execute 改变了发送者</li><li>好了, 现在, 在代码中为机器人自己添加 omega_bot 的 tag, 并监听命令块的消息<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> result </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;tag @s add omega_bot&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- coromega:print(json.encode(result)) 显示 tag add 指令结果, 注意, 如果是第二次add, 可能收到失败的回执</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;已添加 omega_bot 的 tag&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_receive_msg_from_command_block_named</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;#ban&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(chat)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> input </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">msg</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(player_name, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;tag @s add omega_bot&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- coromega:print(json.encode(result)) 显示 tag add 指令结果, 注意, 如果是第二次add, 可能收到失败的回执</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;已添加 omega_bot 的 tag&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_receive_msg_from_command_block_named</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;#ban&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(chat)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">msg</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;封禁时间不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(player_name, {</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_until,</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div></li><li>很显然, 说命令块简单的原因是, 它没有询问参数这个步骤</li></ul><h2 id="step-15-暴露-解封-封禁-api-以供其他组件调用" tabindex="-1">Step 15. 暴露 解封/封禁 API 以供其他组件调用 <a class="header-anchor" href="#step-15-暴露-解封-封禁-api-以供其他组件调用" aria-label="Permalink to &quot;Step 15. 暴露 解封/封禁 API 以供其他组件调用&quot;">​</a></h2><ul><li>如果你以前开发过 dotcs 的组件, 那么对这个功能应该还是挺熟悉的, 也就是所谓的 &quot;前置组件&quot; 。但是和 dotcs 的前置组件不同的是, 在这里, 所有组件都是平行而不分前后, 组件之间可以平行的相互调用。</li><li>好的, 首先让我们在组件内插入api暴露相关代码, api名建议使用类似 url 的 / 来表示不同的功能划分<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_api_named</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/player/ban&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(args, set_result)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args.</span><span style="color:#B392F0;">player_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(args.</span><span style="color:#B392F0;">ban_time</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args.</span><span style="color:#B392F0;">ban_reason</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">set_result</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">({ ok </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, err </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot; </span><span style="color:#E1E4E8;">}))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">set_result</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">({ ok </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, err </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot; </span><span style="color:#E1E4E8;">}))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(player_name, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">set_result</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">        ok </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        detail </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_reason)</span></span>
<span class="line"><span style="color:#E1E4E8;">    }))</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_api_named</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/player/unban&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(args, set_result)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args.</span><span style="color:#B392F0;">player_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">set_result</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">({ ok </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, err </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot; </span><span style="color:#E1E4E8;">}))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">set_result</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">({ ok </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">, detail </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name) }))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">set_result</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">            ok </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            detail </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">                ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        }))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_api_named</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/player/ban&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(args, set_result)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> args.</span><span style="color:#6F42C1;">player_name</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(args.</span><span style="color:#6F42C1;">ban_time</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> args.</span><span style="color:#6F42C1;">ban_reason</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">set_result</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">({ ok </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, err </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;玩家名不能为空&quot; </span><span style="color:#24292E;">}))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">set_result</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">({ ok </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, err </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;封禁时间不能为空&quot; </span><span style="color:#24292E;">}))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(player_name, {</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_until,</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">set_result</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">        ok </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        detail </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">            ban_reason)</span></span>
<span class="line"><span style="color:#24292E;">    }))</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_api_named</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/player/unban&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(args, set_result)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> args.</span><span style="color:#6F42C1;">player_name</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">set_result</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">({ ok </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, err </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;玩家名不能为空&quot; </span><span style="color:#24292E;">}))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">set_result</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">({ ok </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, detail </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name) }))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">set_result</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">            ok </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            detail </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">                ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        }))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div>为了测试和调用这两个 api, 我们还需要另外创建一个组件, 现在输入:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">create check_ban 测试玩家封禁</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">create check_ban 测试玩家封禁</span></span></code></pre></div>以创建新组件,<br> 然后在新组件内部调用刚刚的接口<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> omega </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;omega&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> json </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;json&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#79B8FF;">package.path</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;%s;%s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">package.path</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    omega.</span><span style="color:#B392F0;">storage_path</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">get_code_path</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;LuaLoader&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;?.lua&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> coromega </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;coromega&quot;</span><span style="color:#E1E4E8;">).</span><span style="color:#79B8FF;">from</span><span style="color:#E1E4E8;">(omega)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;config of check_ban:  &quot;</span><span style="color:#E1E4E8;">, json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;check_ban&quot; </span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;测试玩家封禁&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的玩家名: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要的时间: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 调用其他插件的接口</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> result </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">call_other_plugin_api</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/player/ban&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        { player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> player_name, ban_time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_time, ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason })</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> result.</span><span style="color:#B392F0;">ok</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;调用成功: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(result.</span><span style="color:#B392F0;">detail</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;调用失败: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(result.</span><span style="color:#B392F0;">err</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">run</span><span style="color:#E1E4E8;">()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> omega </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;omega&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> json </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;json&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">package.path</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;%s;%s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">package.path</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    omega.</span><span style="color:#6F42C1;">storage_path</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">get_code_path</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;LuaLoader&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;?.lua&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> coromega </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;coromega&quot;</span><span style="color:#24292E;">).</span><span style="color:#005CC5;">from</span><span style="color:#24292E;">(omega)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;config of check_ban:  &quot;</span><span style="color:#24292E;">, json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;check_ban&quot; </span><span style="color:#24292E;">},</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;测试玩家封禁&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的玩家名: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        ban_time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要的时间: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;封禁时间不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 调用其他插件的接口</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">call_other_plugin_api</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/player/ban&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        { player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> player_name, ban_time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_time, ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason })</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> result.</span><span style="color:#6F42C1;">ok</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;调用成功: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(result.</span><span style="color:#6F42C1;">detail</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;调用失败: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(result.</span><span style="color:#6F42C1;">err</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">run</span><span style="color:#24292E;">()</span></span></code></pre></div></li></ul><h2 id="step-16-从-qq-解封和封禁玩家" tabindex="-1">Step 16. 从 QQ 解封和封禁玩家 <a class="header-anchor" href="#step-16-从-qq-解封和封禁玩家" aria-label="Permalink to &quot;Step 16. 从 QQ 解封和封禁玩家&quot;">​</a></h2><ul><li>QQ 最为麻烦之处在于, 它有许多群、频道、私聊, 有许多人。一个人可能在一些群、频道、私聊中, 一个群、频道中不是所有人都有权限, 有权限的人还要把普通聊天信息和指令区分开来。因此, 问题变得格外麻烦。</li><li>首先, 我们需要先读取配置项, 并转换其形式以便后续处理<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.5&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;从QQ接受封禁指令&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#9ECBFF;">&quot;2401PT#1634268014@好友:1634268014&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;#ban 玩家名 秒数 原因&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#9ECBFF;">&quot;2401PT#1634268014@群聊:548589654&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;#ban 玩家名 秒数 原因&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#9ECBFF;">&quot;频道成员-2401PT#31415926545872@频道:2401的频道:机器人测试聊天室&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[CQ:at,qq=144115219209376165] #ban 玩家名 秒数 原因&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;从QQ接受解封指令&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#9ECBFF;">&quot;2401PT#1634268014@好友:1634268014&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;#unban 玩家名&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#9ECBFF;">&quot;2401PT#1634268014@群聊:548589654&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[CQ:at,qq=2041243708] #unban 玩家名&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#9ECBFF;">&quot;频道成员-2401PT#31415926545872@频道:2401的频道:机器人测试聊天室&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[CQ:at,qq=144115219209376165] #unban 玩家名&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.6&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> qq_ban_permission </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;从QQ接受封禁指令&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> qq_unban_permission </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;从QQ接受解封指令&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> qq_ban_matcher </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> who, format </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(qq_ban_permission) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- who is something like &quot;2401PT@好友:1634268014&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- format is something like &quot;#ban 玩家名 时间 原因&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- then replace 玩家名/时间/原因 with .+</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> matcher_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> who </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&gt;&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">format</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;时间&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;秒数&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;原因&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;%1&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 2401PT#1634268014@好友:1634268014 -&gt; 好友:1634268014</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resp_target </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">who</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">who</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">find</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;@&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    qq_ban_matcher[</span><span style="color:#F97583;">#</span><span style="color:#E1E4E8;">qq_ban_matcher </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { matcher_str, resp_target }</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> qq_unban_matcher </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> who, format </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(qq_unban_permission) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> matcher_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> who </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&gt;&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">format</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;%1&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resp_target </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">who</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">who</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">find</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;@&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    qq_unban_matcher[</span><span style="color:#F97583;">#</span><span style="color:#E1E4E8;">qq_unban_matcher </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { matcher_str, resp_target }</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.5&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;从QQ接受封禁指令&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#032F62;">&quot;2401PT#1634268014@好友:1634268014&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;#ban 玩家名 秒数 原因&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#032F62;">&quot;2401PT#1634268014@群聊:548589654&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;#ban 玩家名 秒数 原因&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#032F62;">&quot;频道成员-2401PT#31415926545872@频道:2401的频道:机器人测试聊天室&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[CQ:at,qq=144115219209376165] #ban 玩家名 秒数 原因&quot;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;从QQ接受解封指令&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#032F62;">&quot;2401PT#1634268014@好友:1634268014&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;#unban 玩家名&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#032F62;">&quot;2401PT#1634268014@群聊:548589654&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[CQ:at,qq=2041243708] #unban 玩家名&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#032F62;">&quot;频道成员-2401PT#31415926545872@频道:2401的频道:机器人测试聊天室&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[CQ:at,qq=144115219209376165] #unban 玩家名&quot;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.6&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> qq_ban_permission </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;从QQ接受封禁指令&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> qq_unban_permission </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;从QQ接受解封指令&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> qq_ban_matcher </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> who, format </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(qq_ban_permission) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- who is something like &quot;2401PT@好友:1634268014&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- format is something like &quot;#ban 玩家名 时间 原因&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- then replace 玩家名/时间/原因 with .+</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> matcher_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> who </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&gt;&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">format</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;时间&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;秒数&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;原因&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;%1&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 2401PT#1634268014@好友:1634268014 -&gt; 好友:1634268014</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resp_target </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">who</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">who</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">find</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;@&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    qq_ban_matcher[</span><span style="color:#D73A49;">#</span><span style="color:#24292E;">qq_ban_matcher </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { matcher_str, resp_target }</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> qq_unban_matcher </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> who, format </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(qq_unban_permission) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> matcher_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> who </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&gt;&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">format</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;%1&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resp_target </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">who</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">who</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">find</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;@&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    qq_unban_matcher[</span><span style="color:#D73A49;">#</span><span style="color:#24292E;">qq_unban_matcher </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { matcher_str, resp_target }</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div>其中, 类似 [CQ:at,qq=2041243708] 代表 @机器人 的行为</li><li>接着, 让我们监听 QQ 内的消息:<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_receive_filtered_cqhttp_message_from_default</span><span style="color:#E1E4E8;">():</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(source, name, message)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;cqhttp 默认监听对象&gt; 来源: %s, 名字: %s, 消息: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(source, name, message))</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_receive_filtered_cqhttp_message_from_default</span><span style="color:#24292E;">():</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(source, name, message)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;cqhttp 默认监听对象&gt; 来源: %s, 名字: %s, 消息: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(source, name, message))</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div>其中: <ul><li>message 为用户发送的消息</li><li>source 为消息的来源, 其形式为 好友:qq号 群聊:群号 或者 频道:频道名:聊天室名</li><li>name 为发送者, 形式为 昵称#qq号/频道id</li></ul></li><li>最后, 让我们处理QQ的消息, 并执行相应的封禁和解封指令<div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_receive_filtered_cqhttp_message_from_default</span><span style="color:#E1E4E8;">():</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(source, name, message)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> who </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;%s@%s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(name, source)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> matchers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> qq_ban_matcher[who]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> matchers </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _, matcher_str </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(matchers) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">-- take 玩家名 秒数 原因 from qq_str by matcher_str</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">message</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">matcher_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> matcher_str </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> cmd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">message</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">matcher_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">-- trim space</span></span>
<span class="line"><span style="color:#E1E4E8;">                cmd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cmd</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;%1&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">-- split by space</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> args </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> arg </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cmd</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gmatch</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%S+&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">                    args[</span><span style="color:#F97583;">#</span><span style="color:#E1E4E8;">args </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> arg</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(args[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_cqhttp_message</span><span style="color:#E1E4E8;">(source, </span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_cqhttp_message</span><span style="color:#E1E4E8;">(source, </span><span style="color:#9ECBFF;">&quot;封禁时间无效&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_cqhttp_message</span><span style="color:#E1E4E8;">(source, (</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                    player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(player_name, {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">                })</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)),</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> matchers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> qq_unban_matcher[who]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> matchers </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _, matcher_str </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(matchers) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">-- take 玩家名 秒数 原因 from qq_str by matcher_str</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">message</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">matcher_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> matcher_str </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> cmd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">message</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">matcher_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">-- trim space</span></span>
<span class="line"><span style="color:#E1E4E8;">                cmd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cmd</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;%1&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">-- split by space</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> args </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> arg </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cmd</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gmatch</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%S+&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">                    args[</span><span style="color:#F97583;">#</span><span style="color:#E1E4E8;">args </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> arg</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_cqhttp_message</span><span style="color:#E1E4E8;">(source, </span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_cqhttp_message</span><span style="color:#E1E4E8;">(source, (</span><span style="color:#9ECBFF;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                        player_name))</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">                        ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_cqhttp_message</span><span style="color:#E1E4E8;">(source,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        (</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">                            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_receive_filtered_cqhttp_message_from_default</span><span style="color:#24292E;">():</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(source, name, message)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> who </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;%s@%s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(name, source)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> matchers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> qq_ban_matcher[who]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> matchers </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _, matcher_str </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(matchers) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">-- take 玩家名 秒数 原因 from qq_str by matcher_str</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">message</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#6F42C1;">matcher_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">len</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> matcher_str </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> cmd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">message</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">matcher_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">len</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">-- trim space</span></span>
<span class="line"><span style="color:#24292E;">                cmd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cmd</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;%1&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">-- split by space</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> arg </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cmd</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gmatch</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%S+&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">                    args[</span><span style="color:#D73A49;">#</span><span style="color:#24292E;">args </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> arg</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> args[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(args[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> args[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_cqhttp_message</span><span style="color:#24292E;">(source, </span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_cqhttp_message</span><span style="color:#24292E;">(source, </span><span style="color:#032F62;">&quot;封禁时间无效&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                    ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">                    ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_cqhttp_message</span><span style="color:#24292E;">(source, (</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                    player_name,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">                    ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(player_name, {</span></span>
<span class="line"><span style="color:#24292E;">                    ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_until,</span></span>
<span class="line"><span style="color:#24292E;">                    ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">                })</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)),</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> matchers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> qq_unban_matcher[who]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> matchers </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _, matcher_str </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(matchers) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">-- take 玩家名 秒数 原因 from qq_str by matcher_str</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">message</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#6F42C1;">matcher_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">len</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> matcher_str </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> cmd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">message</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">matcher_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">len</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">-- trim space</span></span>
<span class="line"><span style="color:#24292E;">                cmd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cmd</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;%1&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">-- split by space</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> arg </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cmd</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gmatch</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%S+&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">                    args[</span><span style="color:#D73A49;">#</span><span style="color:#24292E;">args </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> arg</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> args[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_cqhttp_message</span><span style="color:#24292E;">(source, </span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_cqhttp_message</span><span style="color:#24292E;">(source, (</span><span style="color:#032F62;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                        player_name))</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">                        ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_cqhttp_message</span><span style="color:#24292E;">(source,</span></span>
<span class="line"><span style="color:#24292E;">                        (</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">                            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span></code></pre></div></li></ul><h2 id="写在最后" tabindex="-1">写在最后 <a class="header-anchor" href="#写在最后" aria-label="Permalink to &quot;写在最后&quot;">​</a></h2><ul><li>你也许注意到了自带的lua组件的风格和本教程不太一样, 这是因为本教程的写法基于 coromega。coromega 是从 omega 拓展而来, 其相比 omega 会好写很多, 但是性能稍微差一点点。在未来可能内置的组件也会被改为 coromega 的写法</li><li>在本教程中, 展示了许多 api, 但这仅仅是其中一小部分。还有许多 api 没有展示, 甚至方块操作, 建筑文件相关 api 完全没有展示。关于这些 api, 请自行查阅 api 文档</li></ul><h2 id="完整代码" tabindex="-1">完整代码 <a class="header-anchor" href="#完整代码" aria-label="Permalink to &quot;完整代码&quot;">​</a></h2><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> omega </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;omega&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> json </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;json&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#79B8FF;">package.path</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;%s;%s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">package.path</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    omega.</span><span style="color:#B392F0;">storage_path</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">get_code_path</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;LuaLoader&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;?.lua&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> coromega </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;coromega&quot;</span><span style="color:#E1E4E8;">).</span><span style="color:#79B8FF;">from</span><span style="color:#E1E4E8;">(omega)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;config of 玩家封禁:  &quot;</span><span style="color:#E1E4E8;">, json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">take_num_from_string</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(str, unit_names)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- convert &quot;1d2h3m4s&quot; -&gt; 2 by take_num_from_string(&quot;1d2h3m4s&quot;,{ &quot;h&quot;, &quot;H&quot;, &quot;小时&quot;, &quot;时&quot;})</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _, unit_name </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(unit_names) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> num </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">match</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;(%d+)&quot; </span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;"> unit_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> num </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(num)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(ban_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_time </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- time string can be a single number, or a string like &quot;1d2h3m4s&quot;, or chinese like &quot;1天2小时3分钟4秒&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- try to parse as a single number</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> time_num </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">tonumber</span><span style="color:#E1E4E8;">(ban_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> time_num </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_num</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;d&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;D&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;天&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">86400</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;h&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;H&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;小时&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;时&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3600</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;m&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;M&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;分钟&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;分&quot; </span><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60</span></span>
<span class="line"><span style="color:#E1E4E8;">        time_seconds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">take_num_from_string</span><span style="color:#E1E4E8;">(ban_time, { </span><span style="color:#9ECBFF;">&quot;s&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;S&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;秒&quot; </span><span style="color:#E1E4E8;">})</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> time_seconds </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> time_seconds</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_banned_db </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">key_value_db</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家封禁信息&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.1&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;触发词&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;ban&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;玩家封禁&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;封禁玩家&quot; </span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;触发词&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.2&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;被踢出时的提示信息&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;您因为 [ban_reason] 被封禁到 [ban_until]&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;日期显示格式&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;%Y-%m-%d %H:%M:%S&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.3&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> hint_format </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;被踢出时的提示信息&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> date_time_format </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;日期显示格式&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(unix_time)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">os.date</span><span style="color:#E1E4E8;">(date_time_format, unix_time)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> hint_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> hint_format</span></span>
<span class="line"><span style="color:#E1E4E8;">    hint_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hint_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%[ban_reason%]&quot;</span><span style="color:#E1E4E8;">, ban_reason)</span></span>
<span class="line"><span style="color:#E1E4E8;">    hint_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hint_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%[ban_until%]&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> hint_str</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.3&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.4&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ensure_hint_display </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(disp)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> candidates </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get_all_online_players</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> selectable_candidates </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i, candidate </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(candidates) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> idx </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;%s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(i)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">candidate</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">        selectable_candidates[idx] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> name</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">disp</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;%s: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(idx, name))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(selection)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> seleted_candidate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> selectable_candidates[selection]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> seleted_candidate </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> seleted_candidate</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> selection</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resolver </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(info) </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(info) </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">resolver</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的玩家名, 或输入序号: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入封禁原因: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(player_name, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.4&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;解封触发词&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&quot;unban&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;玩家解封&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;解封玩家&quot; </span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.5&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> unban_triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;解封触发词&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_terminal_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> unban_triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从终端解封玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(input)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resolver </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(info) </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(info) </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">resolver</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要解封的玩家名, 或输入序号: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_game_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从游戏内封禁玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(chat)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 如果你希望, 可以这样查看chat内包含的信息:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- print(json.encode(chat))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">name</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> input </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">msg</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- print((&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;):format(caller_name, json.encode(input)))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get_player_by_name</span><span style="color:#E1E4E8;">(caller_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- if caller:is_op() then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--     print(&quot;调用者是 OP&quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- else</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--     -- 实际没必要, 因为菜单已经做了权限控制, 这里只是为了向你展示 coromega 的 player 对象可以做到命令做不到的事</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--     caller:say(&quot;抱歉, 你不是 OP&quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">-- ban_player_name = caller:ask(&quot;请输入要封禁的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resolver </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(info) </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(info) </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">resolver</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的玩家名, 或输入序号: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入封禁原因: &quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(ban_player_name, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_game_menu</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    triggers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> unban_triggers,</span></span>
<span class="line"><span style="color:#E1E4E8;">    argument_hint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[玩家名]&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;从游戏内解封玩家&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(chat)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">name</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> input </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">msg</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(caller_name, json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">(input)))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> caller </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get_player_by_name</span><span style="color:#E1E4E8;">(caller_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">-- ban_player_name = caller:ask(&quot;请输入要解封的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resolver </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(info) </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(info) </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">resolver</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">ask</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;请输入要解封的玩家名, 或输入序号: &quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(ban_player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">caller</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(ban_player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(ban_player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> result </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;tag @s add omega_bot&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- coromega:print(json.encode(result)) 显示 tag add 指令结果, 注意, 如果是第二次add, 可能收到失败的回执</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;已添加 omega_bot 的 tag&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_receive_msg_from_command_block_named</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;#ban&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(chat)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> input </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chat.</span><span style="color:#B392F0;">msg</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(input[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(player_name, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_api_named</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/player/ban&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(args, set_result)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args.</span><span style="color:#B392F0;">player_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(args.</span><span style="color:#B392F0;">ban_time</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args.</span><span style="color:#B392F0;">ban_reason</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">set_result</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">({ ok </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, err </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot; </span><span style="color:#E1E4E8;">}))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">set_result</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">({ ok </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, err </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;封禁时间不能为空&quot; </span><span style="color:#E1E4E8;">}))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(player_name, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">set_result</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">        ok </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        detail </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_reason)</span></span>
<span class="line"><span style="color:#E1E4E8;">    }))</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_called_by_api_named</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/player/unban&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(args, set_result)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args.</span><span style="color:#B392F0;">player_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">set_result</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">({ ok </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, err </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot; </span><span style="color:#E1E4E8;">}))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">set_result</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">({ ok </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">, detail </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name) }))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">set_result</span><span style="color:#E1E4E8;">(json.</span><span style="color:#79B8FF;">encode</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">            ok </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            detail </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">                ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        }))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.5&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;从QQ接受封禁指令&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#9ECBFF;">&quot;2401PT#1634268014@好友:1634268014&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;#ban 玩家名 秒数 原因&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#9ECBFF;">&quot;2401PT#1634268014@群聊:548589654&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;#ban 玩家名 秒数 原因&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#9ECBFF;">&quot;频道成员-2401PT#31415926545872@频道:2401的频道:机器人测试聊天室&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[CQ:at,qq=144115219209376165] #ban 玩家名 秒数 原因&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;从QQ接受解封指令&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#9ECBFF;">&quot;2401PT#1634268014@好友:1634268014&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;#unban 玩家名&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#9ECBFF;">&quot;2401PT#1634268014@群聊:548589654&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[CQ:at,qq=2041243708] #unban 玩家名&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#9ECBFF;">&quot;频道成员-2401PT#31415926545872@频道:2401的频道:机器人测试聊天室&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[CQ:at,qq=144115219209376165] #unban 玩家名&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Version</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;0.0.6&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">update_config</span><span style="color:#E1E4E8;">(coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> qq_ban_permission </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;从QQ接受封禁指令&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> qq_unban_permission </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> coromega.</span><span style="color:#B392F0;">config</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;从QQ接受解封指令&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> qq_ban_matcher </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> who, format </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(qq_ban_permission) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- who is something like &quot;2401PT@好友:1634268014&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- format is something like &quot;#ban 玩家名 时间 原因&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- then replace 玩家名/时间/原因 with .+</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> matcher_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">format</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;时间&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;秒数&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;原因&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;%1&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> matchers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> qq_ban_matcher[who]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> matchers </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        matchers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">        qq_ban_matcher[who] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> matchers</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    matchers[</span><span style="color:#F97583;">#</span><span style="color:#E1E4E8;">matchers </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> matcher_str</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> qq_unban_matcher </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> who, format </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(qq_unban_permission) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> matcher_str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">format</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;玩家名&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;%1&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> resp_target </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">who</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">who</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">find</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;@&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> matchers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> qq_unban_matcher[who]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> matchers </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        matchers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">        qq_unban_matcher[who] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> matchers</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> qq_unban_matcher[who] </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        qq_unban_matcher[who] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    matchers[</span><span style="color:#F97583;">#</span><span style="color:#E1E4E8;">matchers </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> matcher_str</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_receive_filtered_cqhttp_message_from_default</span><span style="color:#E1E4E8;">():</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(source, name, message)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> who </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;%s@%s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(name, source)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> matchers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> qq_ban_matcher[who]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> matchers </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _, matcher_str </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(matchers) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">-- take 玩家名 秒数 原因 from qq_str by matcher_str</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">message</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">matcher_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> matcher_str </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> cmd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">message</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">matcher_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">-- trim space</span></span>
<span class="line"><span style="color:#E1E4E8;">                cmd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cmd</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;%1&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">-- split by space</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> args </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> arg </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cmd</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gmatch</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%S+&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">                    args[</span><span style="color:#F97583;">#</span><span style="color:#E1E4E8;">args </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> arg</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ban_time_to_ban_until_time</span><span style="color:#E1E4E8;">(args[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_cqhttp_message</span><span style="color:#E1E4E8;">(source, </span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_cqhttp_message</span><span style="color:#E1E4E8;">(source, </span><span style="color:#9ECBFF;">&quot;封禁时间无效&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_cqhttp_message</span><span style="color:#E1E4E8;">(source, (</span><span style="color:#9ECBFF;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                    player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_until),</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ban_reason))</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(player_name, {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_until,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_reason,</span></span>
<span class="line"><span style="color:#E1E4E8;">                })</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)),</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> matchers </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> qq_unban_matcher[who]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> matchers </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _, matcher_str </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pairs</span><span style="color:#E1E4E8;">(matchers) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">-- take 玩家名 秒数 原因 from qq_str by matcher_str</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">message</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">matcher_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> matcher_str </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> cmd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">message</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">matcher_str</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">-- trim space</span></span>
<span class="line"><span style="color:#E1E4E8;">                cmd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cmd</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gsub</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;%1&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">-- split by space</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> args </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> arg </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cmd</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">gmatch</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;%S+&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">                    args[</span><span style="color:#F97583;">#</span><span style="color:#E1E4E8;">args </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> arg</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_cqhttp_message</span><span style="color:#E1E4E8;">(source, </span><span style="color:#9ECBFF;">&quot;玩家名不能为空&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_cqhttp_message</span><span style="color:#E1E4E8;">(source, (</span><span style="color:#9ECBFF;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                        player_name))</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">log</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">                        ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_cqhttp_message</span><span style="color:#E1E4E8;">(source,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        (</span><span style="color:#9ECBFF;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#79B8FF;">unix_time_to_date_time_str</span><span style="color:#E1E4E8;">(ban_info.</span><span style="color:#B392F0;">ban_until</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">                            ban_info.</span><span style="color:#B392F0;">ban_reason</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">when_player_change</span><span style="color:#E1E4E8;">():</span><span style="color:#79B8FF;">start_new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(player, action)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> action </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;offline&quot; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> player_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">get</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ban_info </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_info.</span><span style="color:#B392F0;">ban_until</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> ban_reason </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ban_info.</span><span style="color:#B392F0;">ban_reason</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ban_until </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ensure_hint_display </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4.0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">send_ws_cmd</span><span style="color:#E1E4E8;">((</span><span style="color:#9ECBFF;">&quot;kick %s %s&quot;</span><span style="color:#E1E4E8;">):</span><span style="color:#79B8FF;">format</span><span style="color:#E1E4E8;">(player_name, </span><span style="color:#79B8FF;">ban_info_to_hint_str</span><span style="color:#E1E4E8;">(ban_until, ban_reason)), </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">player_banned_db</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">delete</span><span style="color:#E1E4E8;">(player_name)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">coromega</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">run</span><span style="color:#E1E4E8;">()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> omega </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;omega&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> json </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;json&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">package.path</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;%s;%s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">package.path</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    omega.</span><span style="color:#6F42C1;">storage_path</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">get_code_path</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;LuaLoader&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;?.lua&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> coromega </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;coromega&quot;</span><span style="color:#24292E;">).</span><span style="color:#005CC5;">from</span><span style="color:#24292E;">(omega)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;config of 玩家封禁:  &quot;</span><span style="color:#24292E;">, json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">take_num_from_string</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(str, unit_names)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- convert &quot;1d2h3m4s&quot; -&gt; 2 by take_num_from_string(&quot;1d2h3m4s&quot;,{ &quot;h&quot;, &quot;H&quot;, &quot;小时&quot;, &quot;时&quot;})</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _, unit_name </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(unit_names) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> num </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">match</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;(%d+)&quot; </span><span style="color:#D73A49;">..</span><span style="color:#24292E;"> unit_name)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> num </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(num)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(ban_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_time </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- time string can be a single number, or a string like &quot;1d2h3m4s&quot;, or chinese like &quot;1天2小时3分钟4秒&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- try to parse as a single number</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> time_num </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">tonumber</span><span style="color:#24292E;">(ban_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> time_num </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_num</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;d&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;D&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;天&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">86400</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;h&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;H&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;小时&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;时&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3600</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;m&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;M&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;分钟&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;分&quot; </span><span style="color:#24292E;">}) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60</span></span>
<span class="line"><span style="color:#24292E;">        time_seconds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">take_num_from_string</span><span style="color:#24292E;">(ban_time, { </span><span style="color:#032F62;">&quot;s&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;S&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;秒&quot; </span><span style="color:#24292E;">})</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> time_seconds </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> time_seconds</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_banned_db </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">key_value_db</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家封禁信息&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.1&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;触发词&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;ban&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;玩家封禁&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;封禁玩家&quot; </span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.2&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;触发词&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.2&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;被踢出时的提示信息&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;您因为 [ban_reason] 被封禁到 [ban_until]&quot;</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;日期显示格式&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;%Y-%m-%d %H:%M:%S&quot;</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.3&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> hint_format </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;被踢出时的提示信息&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> date_time_format </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;日期显示格式&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unix_time_to_date_time_str</span><span style="color:#24292E;">(unix_time)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">os.date</span><span style="color:#24292E;">(date_time_format, unix_time)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> hint_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hint_format</span></span>
<span class="line"><span style="color:#24292E;">    hint_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hint_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%[ban_reason%]&quot;</span><span style="color:#24292E;">, ban_reason)</span></span>
<span class="line"><span style="color:#24292E;">    hint_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hint_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%[ban_until%]&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> hint_str</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.3&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.4&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ensure_hint_display </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;延迟踢出玩家的时间以保证原因正确显示&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(disp)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> candidates </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get_all_online_players</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> selectable_candidates </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i, candidate </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(candidates) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> idx </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;%s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(i)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">candidate</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">        selectable_candidates[idx] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> name</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">disp</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;%s: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(idx, name))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(selection)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> seleted_candidate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> selectable_candidates[selection]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> seleted_candidate </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> seleted_candidate</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> selection</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resolver </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(info) </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(info) </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">resolver</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的玩家名, 或输入序号: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;封禁时间不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入封禁原因: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(player_name, {</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_until,</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.4&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;解封触发词&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&quot;unban&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;玩家解封&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;解封玩家&quot; </span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.5&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> unban_triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;解封触发词&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_terminal_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> unban_triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从终端解封玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(input)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resolver </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(info) </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(info) </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">resolver</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">input</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要解封的玩家名, 或输入序号: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_game_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名] [时间] [原因]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从游戏内封禁玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(chat)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 如果你希望, 可以这样查看chat内包含的信息:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- print(json.encode(chat))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">name</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">msg</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- print((&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;):format(caller_name, json.encode(input)))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get_player_by_name</span><span style="color:#24292E;">(caller_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- if caller:is_op() then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--     print(&quot;调用者是 OP&quot;)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- else</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--     -- 实际没必要, 因为菜单已经做了权限控制, 这里只是为了向你展示 coromega 的 player 对象可以做到命令做不到的事</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--     caller:say(&quot;抱歉, 你不是 OP&quot;)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">-- ban_player_name = caller:ask(&quot;请输入要封禁的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resolver </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(info) </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(info) </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">resolver</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的玩家名, 或输入序号: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要封禁的时间: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;封禁时间不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入封禁原因: &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(ban_player_name, {</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_until,</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_game_menu</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    triggers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> unban_triggers,</span></span>
<span class="line"><span style="color:#24292E;">    argument_hint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[玩家名]&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;从游戏内解封玩家&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(chat)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">name</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">msg</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;%s 在游戏内唤起了封禁功能, 参数: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(caller_name, json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">(input)))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> caller </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get_player_by_name</span><span style="color:#24292E;">(caller_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">-- ban_player_name = caller:ask(&quot;请输入要解封的玩家名: &quot;)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resolver </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">display_candidates_and_get_selection_resolver_enclosure</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(info) </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(info) </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        ban_player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">resolver</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">ask</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入要解封的玩家名, 或输入序号: &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(ban_player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">caller</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(ban_player_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(ban_player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;tag @s add omega_bot&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- coromega:print(json.encode(result)) 显示 tag add 指令结果, 注意, 如果是第二次add, 可能收到失败的回执</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;已添加 omega_bot 的 tag&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_receive_msg_from_command_block_named</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;#ban&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(chat)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chat.</span><span style="color:#6F42C1;">msg</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(input[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;封禁时间不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;将封禁原因设置为: 未设定&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(player_name, {</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_until,</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_api_named</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/player/ban&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(args, set_result)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> args.</span><span style="color:#6F42C1;">player_name</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(args.</span><span style="color:#6F42C1;">ban_time</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> args.</span><span style="color:#6F42C1;">ban_reason</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">set_result</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">({ ok </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, err </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;玩家名不能为空&quot; </span><span style="color:#24292E;">}))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">set_result</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">({ ok </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, err </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;封禁时间不能为空&quot; </span><span style="color:#24292E;">}))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(player_name, {</span></span>
<span class="line"><span style="color:#24292E;">        ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_until,</span></span>
<span class="line"><span style="color:#24292E;">        ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">set_result</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">        ok </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        detail </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">            ban_reason)</span></span>
<span class="line"><span style="color:#24292E;">    }))</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_called_by_api_named</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/player/unban&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(args, set_result)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> args.</span><span style="color:#6F42C1;">player_name</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">set_result</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">({ ok </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, err </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;玩家名不能为空&quot; </span><span style="color:#24292E;">}))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">set_result</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">({ ok </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, detail </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name) }))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">set_result</span><span style="color:#24292E;">(json.</span><span style="color:#005CC5;">encode</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">            ok </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            detail </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">                ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        }))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.5&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;从QQ接受封禁指令&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#032F62;">&quot;2401PT#1634268014@好友:1634268014&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;#ban 玩家名 秒数 原因&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#032F62;">&quot;2401PT#1634268014@群聊:548589654&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;#ban 玩家名 秒数 原因&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#032F62;">&quot;频道成员-2401PT#31415926545872@频道:2401的频道:机器人测试聊天室&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[CQ:at,qq=144115219209376165] #ban 玩家名 秒数 原因&quot;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;从QQ接受解封指令&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#032F62;">&quot;2401PT#1634268014@好友:1634268014&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;#unban 玩家名&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#032F62;">&quot;2401PT#1634268014@群聊:548589654&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[CQ:at,qq=2041243708] #unban 玩家名&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#032F62;">&quot;频道成员-2401PT#31415926545872@频道:2401的频道:机器人测试聊天室&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[CQ:at,qq=144115219209376165] #unban 玩家名&quot;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Version</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;0.0.6&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">update_config</span><span style="color:#24292E;">(coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> qq_ban_permission </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;从QQ接受封禁指令&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> qq_unban_permission </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> coromega.</span><span style="color:#6F42C1;">config</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;从QQ接受解封指令&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> qq_ban_matcher </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> who, format </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(qq_ban_permission) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- who is something like &quot;2401PT@好友:1634268014&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- format is something like &quot;#ban 玩家名 时间 原因&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- then replace 玩家名/时间/原因 with .+</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> matcher_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">format</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;时间&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;秒数&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;原因&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;%1&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> matchers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> qq_ban_matcher[who]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> matchers </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        matchers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">        qq_ban_matcher[who] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> matchers</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    matchers[</span><span style="color:#D73A49;">#</span><span style="color:#24292E;">matchers </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> matcher_str</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> qq_unban_matcher </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> who, format </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(qq_unban_permission) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> matcher_str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">format</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;玩家名&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;%1&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> resp_target </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">who</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">who</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">find</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;@&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> matchers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> qq_unban_matcher[who]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> matchers </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        matchers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">        qq_unban_matcher[who] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> matchers</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> qq_unban_matcher[who] </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        qq_unban_matcher[who] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    matchers[</span><span style="color:#D73A49;">#</span><span style="color:#24292E;">matchers </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> matcher_str</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_receive_filtered_cqhttp_message_from_default</span><span style="color:#24292E;">():</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(source, name, message)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> who </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;%s@%s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(name, source)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> matchers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> qq_ban_matcher[who]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> matchers </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _, matcher_str </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(matchers) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">-- take 玩家名 秒数 原因 from qq_str by matcher_str</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">message</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#6F42C1;">matcher_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">len</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> matcher_str </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> cmd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">message</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">matcher_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">len</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">-- trim space</span></span>
<span class="line"><span style="color:#24292E;">                cmd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cmd</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;%1&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">-- split by space</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> arg </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cmd</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gmatch</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%S+&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">                    args[</span><span style="color:#D73A49;">#</span><span style="color:#24292E;">args </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> arg</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> args[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ban_time_to_ban_until_time</span><span style="color:#24292E;">(args[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> args[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_cqhttp_message</span><span style="color:#24292E;">(source, </span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_cqhttp_message</span><span style="color:#24292E;">(source, </span><span style="color:#032F62;">&quot;封禁时间无效&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                    ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;未设定&quot;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">                    ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_cqhttp_message</span><span style="color:#24292E;">(source, (</span><span style="color:#032F62;">&quot;封禁玩家: %s 到: %s, 原因: %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                    player_name,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_until),</span></span>
<span class="line"><span style="color:#24292E;">                    ban_reason))</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(player_name, {</span></span>
<span class="line"><span style="color:#24292E;">                    ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_until,</span></span>
<span class="line"><span style="color:#24292E;">                    ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_reason,</span></span>
<span class="line"><span style="color:#24292E;">                })</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)),</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> matchers </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> qq_unban_matcher[who]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> matchers </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _, matcher_str </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pairs</span><span style="color:#24292E;">(matchers) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">-- take 玩家名 秒数 原因 from qq_str by matcher_str</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">message</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#6F42C1;">matcher_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">len</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> matcher_str </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> cmd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">message</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">matcher_str</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">len</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">-- trim space</span></span>
<span class="line"><span style="color:#24292E;">                cmd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cmd</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gsub</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;^%s*(.-)%s*$&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;%1&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">-- split by space</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> arg </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cmd</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">gmatch</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;%S+&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">                    args[</span><span style="color:#D73A49;">#</span><span style="color:#24292E;">args </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> arg</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> args[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_cqhttp_message</span><span style="color:#24292E;">(source, </span><span style="color:#032F62;">&quot;玩家名不能为空&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_cqhttp_message</span><span style="color:#24292E;">(source, (</span><span style="color:#032F62;">&quot;玩家 %s 目前并未被封禁&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                        player_name))</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">log</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">                        ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_cqhttp_message</span><span style="color:#24292E;">(source,</span></span>
<span class="line"><span style="color:#24292E;">                        (</span><span style="color:#032F62;">&quot;解封玩家: %s (原封禁时间 %s, 原因: %s)&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name,</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#005CC5;">unix_time_to_date_time_str</span><span style="color:#24292E;">(ban_info.</span><span style="color:#6F42C1;">ban_until</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">                            ban_info.</span><span style="color:#6F42C1;">ban_reason</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">when_player_change</span><span style="color:#24292E;">():</span><span style="color:#005CC5;">start_new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(player, action)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> action </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;offline&quot; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> player_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">get</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ban_info </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_info.</span><span style="color:#6F42C1;">ban_until</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">local</span><span style="color:#24292E;"> ban_reason </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ban_info.</span><span style="color:#6F42C1;">ban_reason</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ban_until </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ensure_hint_display </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">sleep</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">4.0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">send_ws_cmd</span><span style="color:#24292E;">((</span><span style="color:#032F62;">&quot;kick %s %s&quot;</span><span style="color:#24292E;">):</span><span style="color:#005CC5;">format</span><span style="color:#24292E;">(player_name, </span><span style="color:#005CC5;">ban_info_to_hint_str</span><span style="color:#24292E;">(ban_until, ban_reason)), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">player_banned_db</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">delete</span><span style="color:#24292E;">(player_name)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">coromega</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">run</span><span style="color:#24292E;">()</span></span></code></pre></div>`,41),e=[p];function t(c,r,E,y,i,F){return a(),n("div",null,e)}const q=s(o,[["render",t]]);export{_ as __pageData,q as default};
